@page "/books"
@using Cheesarr.Data
@using Cheesarr.Model
@using Microsoft.EntityFrameworkCore


@inject ILogger<Search>   Logger;
@inject CheesarrDbContext db
@inject NavigationManager NavManager

<PageTitle>Books</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">Books</MudText>

<MudTable Items="@_books" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading" LoadingProgressColor="Color.Info">
    <HeaderContent>
        <MudTh>ID</MudTh>
        <MudTh>Key</MudTh>
        <MudTh>Title</MudTh>
        <MudTh>Author</MudTh>
        <MudTh>Published</MudTh>
        <MudTh>Status</MudTh>
        <MudTh>Cover</MudTh>
        <MudTh>Find</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="ID">@context.Id</MudTd>
        <MudTd DataLabel="Key">@context.Key</MudTd>
        <MudTd DataLabel="Title">@context.Title</MudTd>
        <MudTd DataLabel="Author">@context.Author</MudTd>
        <MudTd DataLabel="Published">@context.FirstPublishYear</MudTd>
        <MudTd DataLabel="Status">@context.Status.ToString()</MudTd>
        <MudTd DataLabel="Cover">
            <MudImage Src="@($"https://covers.openlibrary.org/b/olid/{context.CoverEditionKey}-M.jpg")"
                      Width="100" Height="100"
                      Alt="Icon" Elevation="0"
                      Class="rounded-lg"/>
        </MudTd>
        <MudTd DataLabel="Find">
            <MudButton OnClick="() =>NavigateToBook(context.Id)" Color="Color.Primary">
                Search torrents
            </MudButton>
        </MudTd>
    </RowTemplate>
    <PagerContent>
        <MudTablePager/>
    </PagerContent>
</MudTable>

@code {

    private bool _loading;

    private List<BookEntry> _books = [];

    protected override async Task OnInitializedAsync()
    {
        _loading = true;
        try
        {
            _books = await db.Books.ToListAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError($"Failed to load books: {ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }

    private void NavigateToBook(int id) => NavManager.NavigateTo($"/book/{id}");

}