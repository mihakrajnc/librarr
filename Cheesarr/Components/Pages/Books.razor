@page "/books"
@using Cheesarr.Data
@using Cheesarr.Model
@using Cheesarr.Services
@using Microsoft.EntityFrameworkCore
@using SnackbarService = Cheesarr.Services.SnackMessageBus


@inject ILogger<Search>   Logger;
@inject CheesarrDbContext db
@inject NavigationManager NavManager
@inject GrabService       GrabService
@inject SnackbarService SnackMessageBus;

<PageTitle>Books</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">Books</MudText>

<MudTable Items="@_books" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading" LoadingProgressColor="Color.Info">
    <HeaderContent>
        <MudTh>ID</MudTh>
        <MudTh>OLID</MudTh>
        <MudTh>Title</MudTh>
        <MudTh>Author</MudTh>
        <MudTh>Published</MudTh>
        <MudTh>EB Hash</MudTh>
        <MudTh>Cover</MudTh>
        <MudTh>Find</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="ID">@context.Id</MudTd>
        <MudTd DataLabel="OLID">@context.OLID</MudTd>
        <MudTd DataLabel="Title">@context.Title</MudTd>
        <MudTd DataLabel="Author">@context.Author</MudTd>
        <MudTd DataLabel="Published">@context.FirstPublishYear</MudTd>
        <MudTd DataLabel="EB Hash">@context.EBookTorrentHash.Substring(0, 7)</MudTd>
        <MudTd DataLabel="Cover">
            <MudImage Src="@($"https://covers.openlibrary.org/b/olid/{context.CoverEditionKey}-M.jpg")"
                      Width="100" Height="100"
                      Alt="Icon" Elevation="0"
                      Class="rounded-lg"/>
        </MudTd>
        <MudTd DataLabel="Find">
            <MudButton OnClick="() => GrabBook(context)" Color="Color.Primary">
                Grab
            </MudButton>
        </MudTd>
    </RowTemplate>
    <PagerContent>
        <MudTablePager/>
    </PagerContent>
</MudTable>

@code {

    private bool _loading;

    private List<BookEntry> _books = [];

    protected override async Task OnInitializedAsync()
    {
        _loading = true;
        try
        {
            _books = await db.Books.ToListAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError($"Failed to load books: {ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }

    private void NavigateToBook(int id) => NavManager.NavigateTo($"/book/{id}");

    private async Task GrabBook(BookEntry book)
    {
        SnackMessageBus.ShowInfo("Showing test snackbar.");

        // await GrabService.SearchForBook(book);
    }
}