@page "/search"
@using Cheesarr.Components.Dialogs
@using Cheesarr.Data
@using Cheesarr.Model
@using Cheesarr.Services.Metadata
@using Microsoft.EntityFrameworkCore

@inject IMetadataService MetadataService
@inject CheesarrDbContext  db
@inject IDialogService     DialogService

<PageTitle>Book Search</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">Search</MudText>

<MudTextField Label="Book Title" Variant="Variant.Filled" @bind-Value="@_searchTerm" InputType="InputType.Search"
              Required="true" RequiredError="You can't search for nothing"
              HelperText="The title of your book"/>

<MudButton Class="mb-10" Color="Color.Primary" Variant="Variant.Filled" @onclick="OnSearchClicked">Search</MudButton>

<MudRadioGroup @bind-Value="_entryType">
    <MudRadio Value="@BookEntryType.EBook" Color="Color.Primary" Dense="true">EBook</MudRadio>
    <MudRadio Value="@BookEntryType.Audiobook" Color="Color.Primary" Dense="true">Audiobook</MudRadio>
    <MudRadio Value="@BookEntryType.Both" Color="Color.Primary" Dense="true">Both</MudRadio>
</MudRadioGroup>

<MudCheckBox @bind-Value="_searchOnAdd" Label="Search on Add"/>

<MudTable Items="@_books" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading" LoadingProgressColor="Color.Info">
    <HeaderContent>
        <MudTh>ID</MudTh>
        <MudTh>Title</MudTh>
        <MudTh>Author</MudTh>
        <MudTh>Published</MudTh>
        <MudTh>Grab</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="ID">@context.ID</MudTd>
        <MudTd DataLabel="Title">@context.Title</MudTd>
        <MudTd DataLabel="Author">@context.AuthorName</MudTd>
        <MudTd DataLabel="Published">@context.PublishYear</MudTd>
        <MudTd DataLabel="Grab">
            <MudFab Color="Color.Secondary" Disabled="@(IsBookAlreadyAdded(context))"
                    StartIcon="@Icons.Material.Filled.Add" Size="Size.Small"
                    OnClick="() => OnAddClicked(context)"/>
        </MudTd>
    </RowTemplate>
    <PagerContent>
        <MudTablePager/>
    </PagerContent>
</MudTable>

@code {
    private BookEntryType _entryType = BookEntryType.EBook;
    private string _searchTerm = "";
    private bool _searchOnAdd = true;

    private bool _loading;

    private List<BookSearchItem> _books = new();
    private HashSet<string> _addedBooks = new();

    protected override async Task OnInitializedAsync()
    {
        _addedBooks = await db.Books.Select(be => be.ID).ToHashSetAsync();
    }

    private async Task<bool> IsBookInDatabaseAsync(BookSearchItem book)
    {
        return await db.Books.AnyAsync(b => b.ID == book.ID);
    }

    private bool IsBookAlreadyAdded(BookSearchItem book)
    {
        return _addedBooks.Contains(book.ID);
    }

    private async Task OnSearchClicked()
    {
        _loading = true;

        _books.Clear();

        _books = (await MetadataService.Search(_searchTerm)).ToList();

        _loading = false;
    }

    private async Task OnAddClicked(BookSearchItem book)
    {
        await DialogService.ShowAsync<AddBookDialog>("Add book", new DialogParameters<AddBookDialog>
        {
            { x => x.Book, book }
        });
    }

}