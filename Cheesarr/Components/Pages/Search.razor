@page "/search"
@using Cheesarr.Data
@using Cheesarr.Model
@using Cheesarr.Services
@using Microsoft.EntityFrameworkCore
@using SnackbarService = Cheesarr.Services.SnackMessageBus

@inject GrabService        GrabService
@inject ILogger<Search>    Logger
@inject OpenLibraryService OLS
@inject CheesarrDbContext  db
@inject SnackbarService SnackMessageBus;

<PageTitle>Book Search</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">Search</MudText>

<MudTextField Label="Book Title" Variant="Variant.Filled" @bind-Value="@_searchTerm" InputType="InputType.Search"
              Required="true" RequiredError="You can't search for nothing"
              HelperText="The title of your book"/>

<MudButton Class="mb-10" Color="Color.Primary" Variant="Variant.Filled" @onclick="OnSearchClicked">Search</MudButton>

<MudRadioGroup @bind-Value="_grabType">
    <MudRadio Value="@GrabType.EBook" Color="Color.Primary" Dense="true">EBook</MudRadio>
    <MudRadio Value="@GrabType.Audiobook" Color="Color.Primary" Dense="true">Audiobook</MudRadio>
    <MudRadio Value="@GrabType.Both" Color="Color.Primary" Dense="true">Both</MudRadio>
</MudRadioGroup>

<MudCheckBox @bind-Value="_searchOnAdd" Label="Search on Add"/>

<MudTable Items="@_books" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading" LoadingProgressColor="Color.Info">
    <HeaderContent>
        <MudTh>ID</MudTh>
        <MudTh>Title</MudTh>
        <MudTh>Author</MudTh>
        <MudTh>Published</MudTh>
        <MudTh>Grab</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="ID">@context.key</MudTd>
        <MudTd DataLabel="Title">@context.title</MudTd>
        <MudTd DataLabel="Author">@string.Join(", ", context.author_name)</MudTd>
        <MudTd DataLabel="Published">@context.first_publish_year</MudTd>
        <MudTd DataLabel="Grab">
            <MudFab Color="Color.Secondary" Disabled="@(IsBookAlreadyAdded(context))"
                    StartIcon="@Icons.Material.Filled.Add" Size="Size.Small"
                    OnClick="() => OnAddClicked(context)"/>
        </MudTd>
    </RowTemplate>
    <PagerContent>
        <MudTablePager/>
    </PagerContent>
</MudTable>

@code {
    private GrabType _grabType = GrabType.EBook;
    private string _searchTerm = "";
    private bool _searchOnAdd;
    
    private bool _loading;

    private List<OLDoc> _books = new();
    private HashSet<string> _addedBooks = new();

    protected override async Task OnInitializedAsync()
    {
        _addedBooks = await db.Books.Select(be => be.OLID).ToHashSetAsync();
    }

    private async Task<bool> IsBookInDatabaseAsync(OLDoc book)
    {
        return await db.Books.AnyAsync(b => b.OLID == book.key);
    }

    private bool IsBookAlreadyAdded(OLDoc book)
    {
        return _addedBooks.Contains(book.key);
    }

    private async Task OnSearchClicked()
    {
        _loading = true;

        _books.Clear();

        _books = (await OLS.SearchBooksAsync(_searchTerm)).ToList();

        _loading = false;
    }

    private async Task OnAddClicked(OLDoc book)
    {
        if (await IsBookInDatabaseAsync(book))
        {
            Logger.LogInformation($"{book.title} is already in the database.");
            return;
        }

        Logger.LogInformation($"Saving {book.title} to DB");

        var be = await OLS.AddBook(book, _grabType);
        _addedBooks.Add(book.key);

        if (_searchOnAdd)
        {
            await GrabService.SearchForBook(be);
        }
        
        await db.SaveChangesAsync();
    }

}